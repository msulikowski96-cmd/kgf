# .github/workflows/workflow.yml

# Ten workflow wdraża aplikację Azure Functions po każdym wypchnięciu do gałęzi 'main'.
# Do autoryzacji używa Publish Profile, który należy skonfigurować jako Secret w repozytorium.

name: Deploy Azure Function via Publish Profile

# Trigger: Wykonaj, gdy nastąpi 'push' do gałęzi 'main'
on:
  push:
    branches: [ "main" ]

env:
  # Ustaw tutaj nazwę swojej aplikacji funkcji
  AZURE_FUNCTIONAPP_NAME: YOUR_FUNCTION_APP_NAME_HERE # np. my-function-app
  # Ścieżka do katalogu projektu (relatywna do głównego katalogu repozytorium)
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'                 # np. '.', './src', './dist'
  # Wersja Node.js używana do budowania projektu
  NODE_VERSION: '20.x'                                # Upewnij się, że wersja jest obsługiwana przez Azure Functions

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Sprawdź kod z repozytorium
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      # 2. Ustaw środowisko Node.js
      - name: 'Setup Node ${{ env.NODE_VERSION }} Environment'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 3. Zainstaluj zależności i zbuduj projekt
      - name: 'Resolve Project Dependencies Using Npm'
        shell: bash # Dla Linuxa używamy bash
        run: |
          pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          npm install
          npm run build --if-present
          npm run test --if-present
          popd

      # 4. Wdróż do Azure Functions przy użyciu Publish Profile
      #    Upewnij się, że utworzyłeś Secret o nazwie AZURE_FUNCTIONAPP_PUBLISH_PROFILE
      #    zawierający *treść* pliku .PublishSettings pobranego z Azure Portal.
      - name: 'Run Azure Functions Action'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.hhhNAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }} # Secret zawierający dane Publish Profile
